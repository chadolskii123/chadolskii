{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Base Template</title>
    {% include 'base/css.html' %}
    {% block base_head %}{% endblock %}
</head>
<body>
{% include "base/navbar.html" with brand_name="eCommerce" %}
<!--    include문 안에 with를 쓸 때는 띄어쓰기 없이 써야 한다,,,,,, 하,,,, -->
<div class="container">
    {% block content %}

    {% endblock %}
</div>
{% include 'base/js.html' %}
<script>
    $(document).ready(function () {
        let productForm = $(".form-product-ajax")

        productForm.submit(function (event) {
            event.preventDefault();
            console.log("form is not sending");
            let thisForm = $(this);
            //let actionEndpoint = thisForm.attr('action');
            let actionEndpoint = thisForm.attr('data-endpoint')
            let httpMethod = thisForm.attr('method');
            let formData = thisForm.serialize();

            $.ajax({
                url: actionEndpoint,
                method: httpMethod,
                data: formData,
                success: function (data) {
                    console.log("success");
                    console.log(data);
                    let submitSpan = thisForm.find(".submit-span");
                    if (data.added) {
                        submitSpan.html('<button type="submit" class="btn btn-primary"> Remove?</button>')
                    } else {
                        submitSpan.html(' <button type="submit" class="btn btn-success">Add to Cart</button>')
                    }
                    let navbarCount = $(".navbar-cart-count")

                    if (data['cartItemCount'] < 1) {
                        navbarCount.css("display", "none");
                    } else {
                        navbarCount.css("display", "contents");
                        navbarCount.text(data.cartItemCount);
                    }

                    let currentPath = window.location.href;
                    if (currentPath.indexOf("cart") !== -1) {
                        refreshCart();
                    }


                },
                error: function (errorData) {
                    console.log("error");
                    console.log(errorData);
                }
            });

            function refreshCart() {
                console.log("in current Cart")
                let cartTable = $(".cart-table")
                let cartBody = cartTable.find(".cart-body")

                let productRows = cartBody.find(".cart-product")

                let refreshCartUrl = '/api/cart';
                let refreshCartMethod = "GET";
                let data = {};
                $.ajax({
                    url: refreshCartUrl,
                    method: refreshCartMethod,
                    data: data,
                    success: function (data) {
                        console.log("success");
                        console.log(data);
                        productRows.html("<tr><td colspan=3>Coming Soon</td></tr>")
                        cartBody.find(".cart-subtotal").text(data.subtotal)
                        cartBody.find(".cart-total").text(data.total)
                    },
                    error: function (errorData) {
                        window.location.href = currentUrl;
                    }

                })
            }


        });
    });
</script>
</body>
</html>